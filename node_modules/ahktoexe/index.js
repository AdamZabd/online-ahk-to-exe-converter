const { exec } = require("child_process");
const basePath = __dirname + "/AutoHotkey64.exe";
const exePath = __dirname + "/Ahk2Exe.exe";
var fs = require('fs');
var path = require('path');

function convertFilePath(oldpath, newpath) {
	return new Promise((resolve, reject) => {
		exec('"' + exePath +'" /base ' + basePath + ' /in ' + oldpath + ' /out ' + newpath, function(err, stdout, stderr){
			if (err){
				console.log(err);
				reject();
			}
			
			(async function() {
				await checkExistsWithTimeout(newpath, 60000);
				console.log('Generated');
				resolve();
			})()
		});
	});
}

//I got this from https://stackoverflow.com/questions/26165725/nodejs-check-file-exists-if-not-wait-till-it-exist
function checkExistsWithTimeout(filePath, timeout) {
    return new Promise(function (resolve, reject) {

        var timer = setTimeout(function () {
            watcher.close();
            reject(new Error('File did not exists and was not created during the timeout.'));
        }, timeout);

        fs.access(filePath, fs.constants.R_OK, function (err) {
            if (!err) {
                clearTimeout(timer);
                watcher.close();
                resolve();
            }
        });

        var dir = path.dirname(filePath);
        var basename = path.basename(filePath);
        var watcher = fs.watch(dir, function (eventType, filename) {
            if (eventType === 'rename' && filename === basename) {
                clearTimeout(timer);
                watcher.close();
                resolve();
            }
        });
    });
}

module.exports = convertFilePath;